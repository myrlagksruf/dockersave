FROM ghcr.io/astral-sh/uv:bookworm

WORKDIR /root/workspace

SHELL ["/bin/bash", "-l", "-c"]

ENV NVM_DIR=/usr/local/nvm
ENV LC_ALL=ko_KR.UTF-8
ENV PATH=$PATH:/opt/oracle/instantclient_23_4
RUN mkdir -p /opt/oracle && mkdir -p /root/workspace && mkdir -p /root/.config/uv
COPY clangd /root/.clangd

RUN rm -rf /var/lib/apt/lists/* && \
    uv python install 3.8 3.12 && \
    wget -O restic.bz2 https://github.com/restic/restic/releases/download/v0.18.0/restic_0.18.0_linux_amd64.bz2 &&\
    bunzip2 restic.bz2 && \
    chmod +x restic &&\
    mv restic /usr/local/bin/ && \
    rm -f restic.bz2 && \
    # localedef -f UTF-8 -i ko_KR ko_KR.UTF-8 && \
    cd /opt/oracle && \
    curl -O https://download.oracle.com/otn_software/linux/instantclient/2340000/instantclient-basiclite-linux.x64-23.4.0.24.05.zip && \
    unzip instantclient-basiclite-linux.x64-23.4.0.24.05.zip && \
    rm -rf instantclient-basiclite-linux.x64-23.4.0.24.05.zip META-INF && \
    curl -O https://download.oracle.com/otn_software/linux/instantclient/2340000/instantclient-sqlplus-linux.x64-23.4.0.24.05.zip && \
    unzip instantclient-sqlplus-linux.x64-23.4.0.24.05.zip && \
    rm -rf instantclient-sqlplus-linux.x64-23.4.0.24.05.zip META-INF && \
    echo /opt/oracle/instantclient_23_4 > /etc/ld.so.conf.d/oracle-instantclient.conf && \
    cd /root/workspace && \
    mkdir /usr/local/nvm && \
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash && \
    source $NVM_DIR/nvm.sh && \
    nvm install 16 && \
    nvm install 22 && \
    nvm use 16 && \
    npm i -g yarn && \
    yarn config set registry "http://10.20.20.123:8081/repository/npm-proxy/" && \
    yarn config set ignore-engines true && \
    nvm use 22 && \
    npm i -g npm yarn && \
    yarn config set registry "http://10.20.20.123:8081/repository/npm-proxy/" && \
    yarn config set ignore-engines true && \
    echo '[pip]' >> /root/.config/uv/uv.toml && \
    echo 'index-url = "http://10.20.20.123:8081/repository/pypi-proxy/simple/"' >> /root/.config/uv/uv.toml && \
    echo -e 'Types: deb\nURIs: http://10.20.20.123:8081/repository/apt-debian12-proxy/\nSuites: bookworm bookworm-updates\nComponents: main' > /etc/apt/sources.list.d/debian-sources

WORKDIR /root/workspace

ENTRYPOINT [ "/bin/bash" ]